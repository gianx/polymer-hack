<!DOCTYPE HTML>
<html>
<head>
<title>Flask/Gevent WebSocket Test</title>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.4.2.min.js"></script>
<script type="text/javascript" charset="utf-8">
function waitForSocketConnection(socket, callback){
    setTimeout(
        function () {
            if (socket.readyState === 1) {
                console.log("Connection is made")
                if(callback != null){
                    callback();
                }
                return;

            } else {
                console.log("wait for connection...")
                waitForSocketConnection(socket, callback);
            }

        }, 5); // wait 5 milisecond for the connection...
}


$(document).ready(function(){
    $('form').submit(function(event){
        
        
        
        waitForSocketConnection(ws, function(){
                console.log("message sent!!!");
                ws.send($('#data').val())
                console.log('SENT')
            });
        return false;
    });
    if ("WebSocket" in window) {
        console.log("ws://" + document.domain + ":5000/api");
        ws = new WebSocket("ws://" + document.domain + ":5000/api");
        ws.onmessage = function (msg) {
            $("#log").html("<p>"+msg.data+"</p>")
        };
        console.log(ws);
        } else {
        alert("WebSocket not supported");
    }
});
</script>
</head>
<body>
<h1>Send:</h1>
<form method='POST' action='#'>
<textarea name='data' id="data"></textarea>
<div><input type='submit'></div>
</form>
<h1>Receive:</h1>
<div id="log"></div>
</body>
</html>